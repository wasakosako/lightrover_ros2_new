# `lightrover_ros` パッケージ

このパッケージは、LightRoverを実際に制御するための主要なROSノード群を含んでいます。Pythonで実装されており、ハードウェアとの通信、オドメトリの計算、高レベルな動作指示の受信など、ロボットの核となる機能を担当します。

## 主要なノード

-   **`odometry.py` (`wrc201_odometry`ノード)**:
    -   モーターエンコーダーから回転数を読み取り、それを基にロボットの移動速度と移動距離を計算します。
    -   計算したオドメトリ情報（位置、速度）を`/odom`トピックに`nav_msgs/Odometry`メッセージとしてパブリッシュします。
    -   `odom` -> `base_footprint`のTF（座標変換）情報をブロードキャストします。これは、ナビゲーションスタックがロボットの動きを追跡するために不可欠です。

-   **`pos_controller.py` (`pos_controller`ノード)**:
    -   `/rover_twist`トピックから目標速度（`geometry_msgs/Twist`）を購読します。
    -   現在のロボットの速度（`/odom`から取得）と目標速度を比較し、PID制御などを用いてモーターに出力するべきパワーを計算します。
    -   計算されたモーター出力を、I2C通信を介してモータードライバ（WRC-201）に送信します。

-   **`rover_gamepad.py` (`rover_gamepad`ノード)**:
    -   `/joy`トピック（`joy`ノードからパブリッシュされる）からゲームパッドの入力を購読します。
    -   ゲームパッドのスティック操作を、ロボットの並進速度と回転速度に変換します。
    -   変換した速度情報を`/rover_twist`トピックに`geometry_msgs/Twist`メッセージとしてパブリッシュし、`pos_controller`ノードにロボットの制御を指示します。

-   **`i2c_controller.py` (`wrc201_i2c`サービス)**:
    -   他のノードからの要求に応じて、I2Cバスを介してWRC-201モータードライバとの間でデータの読み書きを行うサービスを提供します。これにより、ハードウェアへのアクセスを一元管理し、競合を防ぎます。

## 動作の仕組み

これらのノードは連携して動作します。例えば、ゲームパッドで操作する場合のデータの流れは以下のようになります。

1.  **`joy`ノード**: ゲームパッドの物理的な操作を検出し、`/joy`トピックにパブリッシュします。
2.  **`rover_gamepad`ノード**: `/joy`を購読し、ロボットの目標速度（Twist）に変換して`/rover_twist`にパブリッシュします。
3.  **`pos_controller`ノード**: `/rover_twist`を購読し、現在のオドメトリ（`/odom`）を参考にしながら、モーターへの指令値を計算し、`wrc201_i2c`サービスを呼び出してモーターを駆動します。
4.  **`odometry`ノード**: モーターエンコーダーの値を読み取り、実際のロボットの動きを計算して`/odom`トピックとTFを更新します。

SLAMやナビゲーションを実行する際も、`Nav2`スタックが`/rover_twist`トピックに目標速度をパブリッシュすることで、同様の仕組みでロボットが制御されます。
